# payment Specification

## Purpose
TBD - created by archiving change add-payment-integration-api. Update Purpose after archive.
## Requirements
### Requirement: 用户钱包管理

系统 SHALL 为每个用户提供独立的电子钱包，支持余额查询、充值和提现功能。

#### Scenario: 创建用户钱包

- **WHEN** 用户首次注册
- **THEN** 系统自动创建该用户的钱包，初始余额为 0

#### Scenario: 查询钱包余额

- **WHEN** 用户请求查看钱包信息
- **THEN** 返回当前余额、冻结金额和可用余额

#### Scenario: 钱包充值

- **WHEN** 用户发起充值请求（金额、支付方式）
- **THEN** 创建充值订单，调用第三方支付接口，支付成功后增加钱包余额

#### Scenario: 提现申请

- **WHEN** 用户申请提现（金额、提现账户）
- **THEN** 验证可用余额充足，冻结提现金额，创建提现记录，等待管理员审核

#### Scenario: 提现失败

- **WHEN** 提现金额超过可用余额
- **THEN** 返回错误提示"余额不足"

---

### Requirement: 钱包交易记录

系统 SHALL 记录所有钱包的收入和支出交易，提供交易历史查询功能。

#### Scenario: 记录充值交易

- **WHEN** 充值成功
- **THEN** 创建交易记录（类型：充值，金额：充值金额，余额变动：+充值金额）

#### Scenario: 记录消费交易

- **WHEN** 使用余额支付订单
- **THEN** 创建交易记录（类型：消费，金额：订单金额，余额变动：-订单金额，关联订单 ID）

#### Scenario: 记录退款交易

- **WHEN** 订单退款到钱包
- **THEN** 创建交易记录（类型：退款，金额：退款金额，余额变动：+退款金额，关联订单 ID）

#### Scenario: 查询交易记录

- **WHEN** 用户请求查看交易记录（可选筛选条件：交易类型、时间范围）
- **THEN** 返回交易记录列表（时间倒序）

---

### Requirement: 订单支付

系统 SHALL 支持用户使用钱包余额、微信支付或支付宝支付订单，并支持组合支付。

#### Scenario: 钱包余额支付

- **WHEN** 用户选择余额支付且余额充足
- **THEN** 扣减钱包余额，更新订单状态为"已支付"，创建支付记录

#### Scenario: 余额不足无法支付

- **WHEN** 用户选择余额支付但余额不足
- **THEN** 返回错误提示"余额不足，请充值或选择其他支付方式"

#### Scenario: 第三方支付（预留）

- **WHEN** 用户选择微信支付或支付宝支付
- **THEN** 调用第三方支付接口，返回支付参数，用户完成支付后回调更新订单状态

#### Scenario: 组合支付

- **WHEN** 用户选择余额+第三方组合支付
- **THEN** 优先扣减钱包余额，不足部分通过第三方支付，全部成功后订单支付成功

#### Scenario: 支付超时

- **WHEN** 订单创建后 15 分钟内未完成支付
- **THEN** 订单自动取消，释放库存

---

### Requirement: 支付回调处理

系统 SHALL 正确处理微信支付和支付宝的异步支付回调通知。

#### Scenario: 微信支付回调成功

- **WHEN** 收到微信支付成功回调
- **THEN** 验证签名，更新支付记录状态，更新订单状态为"已支付"，返回成功响应

#### Scenario: 支付宝回调成功

- **WHEN** 收到支付宝支付成功回调
- **THEN** 验证签名，更新支付记录状态，更新订单状态为"已支付"，返回成功响应

#### Scenario: 回调签名验证失败

- **WHEN** 收到支付回调但签名验证失败
- **THEN** 记录警告日志，返回失败响应，不更新订单状态

#### Scenario: 重复回调

- **WHEN** 收到同一订单的重复支付回调
- **THEN** 检查支付记录已存在，返回成功响应（幂等处理）

---

### Requirement: 订单退款

系统 SHALL 支持订单退款，根据支付方式原路返回或退到钱包。

#### Scenario: 钱包支付订单退款

- **WHEN** 管理员处理钱包支付订单的退款申请
- **THEN** 增加用户钱包余额，更新订单支付状态为"已退款"，创建退款记录

#### Scenario: 第三方支付订单退款（预留）

- **WHEN** 管理员处理第三方支付订单的退款申请
- **THEN** 调用第三方退款接口，等待退款回调，更新订单支付状态为"已退款"

#### Scenario: 部分退款

- **WHEN** 退款金额小于实付金额
- **THEN** 按比例退款到各支付渠道，创建退款记录

#### Scenario: 退款失败

- **WHEN** 退款金额超过实付金额
- **THEN** 返回错误提示"退款金额不能超过实付金额"

---

### Requirement: 支付配置管理

系统 SHALL 允许管理员配置微信支付和支付宝支付参数。

#### Scenario: 配置微信支付

- **WHEN** 管理员输入微信支付配置（商户号、API 密钥、证书）
- **THEN** 验证配置格式正确，加密存储敏感信息，保存配置

#### Scenario: 配置支付宝支付

- **WHEN** 管理员输入支付宝配置（应用 ID、应用私钥、支付宝公钥）
- **THEN** 验证配置格式正确，加密存储敏感信息，保存配置

#### Scenario: 测试支付配置

- **WHEN** 管理员点击"测试配置"
- **THEN** 调用支付接口进行连接测试，返回测试结果

#### Scenario: 启用/禁用支付方式

- **WHEN** 管理员切换支付方式状态
- **THEN** 更新配置状态，用户端支付选项实时生效

---

### Requirement: 提现审核

系统 SHALL 支持管理员审核用户的提现申请。

#### Scenario: 审核通过提现

- **WHEN** 管理员审核通过提现申请
- **THEN** 扣减用户钱包余额，解冻冻结金额，创建提现记录，标记为"已完成"

#### Scenario: 审核拒绝提现

- **WHEN** 管理员拒绝提现申请（填写原因）
- **THEN** 解冻冻结金额，不扣减余额，标记提现记录为"已拒绝"，通知用户

#### Scenario: 查询提现记录

- **WHEN** 管理员查看提现记录列表
- **THEN** 返回所有提现记录（可筛选状态：待审核/已完成/已拒绝）

---

### Requirement: 钱包余额管理（管理端）

系统 SHALL 允许管理员查看和管理用户钱包。

#### Scenario: 查看用户钱包列表

- **WHEN** 管理员查看钱包列表
- **THEN** 返回所有用户钱包信息（用户信息、余额、冻结金额）

#### Scenario: 查看用户钱包详情

- **WHEN** 管理员查看指定用户钱包详情
- **THEN** 返回钱包信息和交易记录

#### Scenario: 手动调整余额（特殊情况）

- **WHEN** 管理员手动调整用户余额（填写原因）
- **THEN** 修改钱包余额，创建交易记录（类型：调整，备注：原因）

---

### Requirement: 支付安全

系统 SHALL 确保支付过程的安全性，防止欺诈和篡改。

#### Scenario: 支付签名验证

- **WHEN** 收到支付回调
- **THEN** 验证签名是否正确，签名错误拒绝处理

#### Scenario: 支付金额校验

- **WHEN** 处理支付回调
- **THEN** 校验回调金额与订单金额是否一致，不一致拒绝处理

#### Scenario: 防止重放攻击

- **WHEN** 收到支付回调
- **THEN** 检查时间戳有效性和 nonce 唯一性，防止重放

#### Scenario: 敏感信息加密

- **WHEN** 存储支付配置（API 密钥、私钥）
- **THEN** 使用加密算法加密存储，使用时解密


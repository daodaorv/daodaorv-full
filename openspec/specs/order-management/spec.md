# order-management Specification

## Purpose
TBD - created by archiving change add-order-management-api. Update Purpose after archive.
## Requirements
### Requirement: 订单创建

系统 SHALL 提供订单创建功能，允许用户创建房车租赁订单。

#### Scenario: 成功创建订单

- **WHEN** 用户提供有效的车辆 ID、开始日期、结束日期、取车门店 ID
- **THEN** 系统创建订单，自动生成订单号（ORD + YYYYMMDD + 6 位序号），计算租赁价格、保险价格、总价格和押金，返回订单详情

#### Scenario: 车辆不可用

- **WHEN** 用户选择的车辆在租期内不可用或有时间冲突
- **THEN** 系统返回错误"车辆在该时间段不可用"，状态码 400

#### Scenario: 日期无效

- **WHEN** 用户提供的开始日期早于当前日期+1 天，或结束日期早于开始日期
- **THEN** 系统返回错误"日期无效"，状态码 400

---

### Requirement: 我的订单列表

系统 SHALL 提供我的订单列表查询功能，允许用户查看自己的订单。

#### Scenario: 查询订单列表成功

- **WHEN** 用户请求订单列表，可选按状态筛选
- **THEN** 系统返回分页的订单列表，包含订单号、车辆信息、租期、状态、价格等

#### Scenario: 按状态筛选

- **WHEN** 用户按状态筛选订单（如只查看"使用中"的订单）
- **THEN** 系统返回符合条件的订单列表

---

### Requirement: 订单详情查询

系统 SHALL 提供订单详情查询功能，允许用户查看订单的完整信息。

#### Scenario: 查询订单详情成功

- **WHEN** 用户请求查看自己的订单详情
- **THEN** 系统返回订单的完整信息，包含用户信息、车辆信息、租期、价格明细、状态等

#### Scenario: 无权查看他人订单

- **WHEN** 用户尝试查看其他用户的订单
- **THEN** 系统返回错误"无权访问该订单"，状态码 403

---

### Requirement: 订单取消

系统 SHALL 提供订单取消功能，允许用户取消待支付或已支付的订单。

#### Scenario: 取消待支付订单

- **WHEN** 用户取消状态为"待支付"的订单
- **THEN** 系统更新订单状态为"已取消"，释放车辆预订

#### Scenario: 取消已支付订单

- **WHEN** 用户取消状态为"已支付"的订单
- **THEN** 系统更新订单状态为"已取消"，触发退款流程

#### Scenario: 无法取消使用中订单

- **WHEN** 用户尝试取消状态为"使用中"的订单
- **THEN** 系统返回错误"当前订单状态不可取消"，状态码 400

---

### Requirement: 订单状态管理

系统 SHALL 提供订单状态管理功能，允许管理员更新订单状态。

#### Scenario: 更新订单状态成功

- **WHEN** 管理员将订单状态从"已支付"更新为"待取车"
- **THEN** 系统更新订单状态，记录状态变更历史

#### Scenario: 非法状态转换

- **WHEN** 管理员尝试非法的状态转换（如从"已完成"到"待支付"）
- **THEN** 系统返回错误"非法的状态转换"，状态码 400

---

### Requirement: 退款处理

系统 SHALL 提供退款处理功能，允许管理员处理订单退款。

#### Scenario: 处理退款成功

- **WHEN** 管理员处理已取消订单的退款，提供退款金额
- **THEN** 系统更新退款金额和支付状态，调用支付接口退款（预留）

#### Scenario: 退款金额超过订单总额

- **WHEN** 管理员提供的退款金额超过订单总额
- **THEN** 系统返回错误"退款金额不能超过订单总额"，状态码 400

---

### Requirement: 管理端订单列表

系统 SHALL 提供管理端订单列表查询功能，允许管理员查看和管理所有订单。

#### Scenario: 查询所有订单

- **WHEN** 管理员请求订单列表
- **THEN** 系统返回分页的订单列表，支持按状态、类型、日期、门店、用户筛选

#### Scenario: 关键词搜索

- **WHEN** 管理员使用关键词搜索订单（订单号、用户手机号、车牌号）
- **THEN** 系统返回匹配的订单列表

---

### Requirement: 权限控制

系统 SHALL 确保用户只能访问自己的订单，管理员可以访问所有订单。

#### Scenario: 用户访问自己的订单

- **WHEN** 用户访问自己的订单
- **THEN** 系统允许访问并返回订单信息

#### Scenario: 用户访问他人订单被拒绝

- **WHEN** 用户尝试访问其他用户的订单
- **THEN** 系统返回错误"无权访问该订单"，状态码 403

#### Scenario: 管理员访问所有订单

- **WHEN** 管理员访问任何订单
- **THEN** 系统允许访问并返回订单信息

---

### Requirement: 数据验证

系统 SHALL 验证所有订单相关的输入数据。

#### Scenario: 必填字段验证

- **WHEN** 用户创建订单时缺少必填字段（如车辆 ID、开始日期）
- **THEN** 系统返回错误"缺少必填字段"，状态码 400

#### Scenario: 日期格式验证

- **WHEN** 用户提供无效的日期格式
- **THEN** 系统返回错误"日期格式无效"，状态码 400

---

### Requirement: 测试覆盖

系统 SHALL 为所有订单管理 API 提供完整的测试覆盖。

#### Scenario: 单元测试通过

- **WHEN** 运行订单管理 API 的单元测试
- **THEN** 所有测试用例通过（100% 通过率）

#### Scenario: 集成测试通过

- **WHEN** 运行订单管理 API 的集成测试
- **THEN** 所有测试用例通过，包括订单完整流程测试（创建 → 支付 → 取车 → 还车 → 完成）


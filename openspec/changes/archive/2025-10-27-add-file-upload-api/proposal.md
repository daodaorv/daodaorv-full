# 变更提案：文件上传 API

## Why

当前系统缺少文件上传功能，而业务场景中有大量文件上传需求：

**核心业务场景**：

1. **用户认证**：用户需要上传身份证照片（正反面）、驾驶证照片（正反面）进行实名认证和驾照认证
2. **车辆管理**：每辆车需要上传 8-15 张高清图片（外观、内饰、配置细节）
3. **用户资料**：用户需要上传头像
4. **社区内容**：用户发帖需要上传 1-3 张配图
5. **客服系统**：用户在客服聊天中需要发送图片
6. **营地和旅游**：营地和旅游路线需要上传多张展示图片（10-20 张）

**业务痛点**：

- 如果文件存储在服务器本地，会快速占满磁盘空间
- 服务器带宽有限，大量图片访问会影响 API 性能
- 无法实现 CDN 加速，用户访问图片速度慢
- 缺乏图片处理能力（缩略图、格式转换、水印）

**业务价值**：

- 提供统一的文件上传服务，支撑所有业务场景
- 使用阿里云 OSS 实现高可用、高性能的文件存储
- 自动 CDN 加速，提升用户体验
- 支持图片处理（缩略图、格式转换），节省带宽成本
- 降低服务器压力，提高系统稳定性

---

## What Changes

### 1. 数据模型层

**UploadFile（上传文件记录）**：

- 文件基本信息：原始文件名、文件大小、MIME 类型
- 存储信息：OSS URL、OSS Key、存储桶名称
- 分类信息：文件类型（image/document）、业务类型（avatar/idcard/vehicle 等）
- 关联信息：上传用户 ID、关联业务 ID（可选）
- 状态信息：上传状态、审核状态（可选）
- 时间戳：上传时间、更新时间

### 2. 业务逻辑层

**FileUploadService（文件上传服务）**：

- 文件验证（大小、格式、安全检查）
- 生成唯一文件名（避免冲突）
- 上传到阿里云 OSS
- 生成访问 URL
- 记录上传信息到数据库
- 图片处理（缩略图、格式转换）
- 文件删除（从 OSS 和数据库）

**OSSService（阿里云 OSS 服务）**：

- OSS 初始化和配置管理
- 文件上传（普通上传、分片上传）
- 文件下载（生成签名 URL）
- 文件删除
- 图片处理（缩略图、水印、格式转换）
- 获取文件元数据

### 3. API 控制器层

**UploadController（文件上传控制器）**：

**用户端 API**：

- 上传图片（头像、身份证、驾照、社区图片）
- 上传文档（PDF、Word 等）
- 删除文件（自己上传的文件）
- 获取文件上传记录

**管理端 API**：

- 批量上传（车辆图片、营地图片）
- 获取所有文件列表（分页、筛选）
- 删除任意文件
- 获取上传统计信息
- OSS 配置管理

### 4. 工具类和中间件

- `backend/src/utils/oss.ts`：阿里云 OSS SDK 封装
- `backend/src/utils/file-validator.ts`：文件验证工具（格式、大小、安全）
- `backend/src/utils/file-name-generator.ts`：文件名生成工具（唯一性、路径规则）
- `backend/src/utils/image-processor.ts`：图片处理工具（缩略图、格式转换）
- `backend/src/middlewares/upload.middleware.ts`：文件上传中间件（Multer 配置）

---

## Impact

### 影响的模块

- **新增模块**：文件上传服务
- **依赖模块**：用户认证（用户 ID）
- **未来依赖**：车辆管理、社区管理、客服系统、营地管理、旅游管理

### 数据库变更

- 新增表：`upload_files`（上传文件记录表）

### API 变更

**新增 API**：

**用户端**：

- `POST /api/upload/image` - 上传图片
- `POST /api/upload/document` - 上传文档
- `DELETE /api/upload/:fileId` - 删除文件
- `GET /api/upload/my-files` - 获取我的文件列表

**管理端**：

- `POST /api/admin/upload/batch` - 批量上传
- `GET /api/admin/upload/files` - 获取所有文件列表
- `DELETE /api/admin/upload/:fileId` - 删除任意文件
- `GET /api/admin/upload/stats` - 上传统计信息
- `POST /api/admin/upload/config` - 配置 OSS 参数

### 配置变更

**环境变量**（需在 `.env` 中配置）：

```env
# 阿里云 OSS 配置
OSS_REGION=oss-cn-beijing
OSS_ACCESS_KEY_ID=your_access_key_id
OSS_ACCESS_KEY_SECRET=your_access_key_secret
OSS_BUCKET=your_bucket_name
OSS_ENDPOINT=https://oss-cn-beijing.aliyuncs.com
OSS_DOMAIN=https://your-bucket.oss-cn-beijing.aliyuncs.com

# 文件上传限制
MAX_FILE_SIZE=10485760  # 10MB
MAX_IMAGE_SIZE=5242880  # 5MB
MAX_DOCUMENT_SIZE=10485760  # 10MB
```

### 安全考虑

- 文件格式白名单验证（仅允许特定格式）
- 文件大小限制（防止资源耗尽）
- 文件内容安全扫描（防止恶意文件）
- 签名 URL 过期时间（临时访问权限）
- 用户只能删除自己上传的文件
- 敏感图片（身份证、驾照）访问权限控制

---

## 实施阶段

### 阶段 1：基础架构（优先）

- 创建数据模型（UploadFile）
- 搭建 OSS 服务封装
- 实现文件验证工具
- 实现文件名生成工具

### 阶段 2：图片上传功能

- 实现图片上传 API
- 支持常见图片格式（JPG、PNG、WebP）
- 自动生成缩略图
- 支持图片格式转换（转 WebP）

### 阶段 3：文档上传功能

- 实现文档上传 API
- 支持常见文档格式（PDF、Word、Excel）
- 文件安全扫描

### 阶段 4：管理功能

- 实现批量上传
- 实现文件管理（列表、删除）
- 实现上传统计
- 实现 OSS 配置管理

### 阶段 5：测试与文档

- 编写单元测试
- 编写集成测试
- 生成 API 文档
- 验收和归档

---

## 业务规则

### 文件上传规则

**图片上传**：

- 支持格式：JPG、JPEG、PNG、WebP、GIF
- 最大尺寸：5MB
- 自动生成缩略图：200x200、400x400、800x800
- 自动转换为 WebP 格式（节省带宽）

**文档上传**：

- 支持格式：PDF、DOC、DOCX、XLS、XLSX
- 最大尺寸：10MB
- 文件安全扫描

**文件命名规则**：

```
{业务类型}/{年月}/{UUID}.{扩展名}

示例：
avatar/202510/550e8400-e29b-41d4-a716-446655440000.jpg
idcard/202510/550e8400-e29b-41d4-a716-446655440001.jpg
vehicle/202510/550e8400-e29b-41d4-a716-446655440002.jpg
```

**存储路径分类**：

- `avatar/` - 用户头像
- `idcard/` - 身份证照片
- `license/` - 驾驶证照片
- `vehicle/` - 车辆图片
- `community/` - 社区图片
- `campsite/` - 营地图片
- `travel/` - 旅游图片
- `document/` - 文档
- `other/` - 其他

### 权限规则

- 登录用户才能上传文件
- 用户只能删除自己上传的文件
- 管理员可以删除任意文件
- 敏感文件（身份证、驾照）需要权限才能访问

### 清理规则

- 未关联业务的文件，7 天后自动删除
- 用户注销后，其上传的文件保留 30 天后删除
- 删除业务数据时，同步删除关联文件

---

## 非功能性需求

- **性能**：上传接口响应时间 < 3 秒
- **可靠性**：上传成功率 ≥ 99.9%
- **安全性**：文件验证、内容扫描、访问权限控制
- **可扩展性**：支持后续接入更多云存储服务（腾讯云 COS、七牛云等）
- **可维护性**：完善的日志记录、错误追踪

---

## 技术选型

### 阿里云 OSS

**选择原因**：

- 高可用性：99.99% SLA
- 自动 CDN 加速
- 强大的图片处理能力
- 成本低：存储 ¥0.12/GB/月，流量 ¥0.5/GB
- 官方 Node.js SDK 完善

**OSS 功能使用**：

- 标准存储：常用文件（车辆图片、用户头像）
- 低频存储：不常用文件（历史订单附件）
- 图片处理：缩略图、格式转换、水印
- 访问控制：签名 URL、Referer 白名单

### Multer

**选择原因**：

- Koa 生态成熟的文件上传中间件
- 支持内存存储、本地存储、自定义存储
- 支持文件大小限制、格式限制
- 易于集成和扩展

---

**提案创建时间**：2025-10-27
**提案作者**：叨叨房车开发团队
**优先级**：P0（核心基础能力）
**预计工期**：2-3 天


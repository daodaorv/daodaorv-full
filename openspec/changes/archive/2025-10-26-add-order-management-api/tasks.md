# Tasks: 订单管理 API 开发

## 概述

本任务清单用于跟踪订单管理 API 的开发进度。

---

## Phase 1: 基础架构

### 1.1 数据模型层

- [x] 创建 `backend/src/entities/Order.ts` - Order 实体定义
- [x] 定义 OrderStatus 枚举
- [x] 定义 PaymentStatus 枚举
- [x] 在 `database.ts` 中注册 Order 实体

### 1.2 工具类

- [x] 创建 `backend/src/utils/order-number.ts` - 订单号生成工具
- [x] 实现订单号格式：ORD + YYYYMMDD + 6 位序号
- [x] 确保订单号唯一性

---

## Phase 2: 核心业务逻辑

### 2.1 订单创建

- [x] 创建 `backend/src/services/order.service.ts`
- [x] 实现 `createOrder()` - 创建订单
  - [x] 验证用户登录状态
  - [x] 验证车辆可用性
  - [x] 检查车辆时间冲突
  - [x] 计算租赁天数
  - [x] 计算租赁价格
  - [x] 计算保险价格
  - [x] 计算附加服务价格
  - [x] 计算总价格和押金
  - [x] 生成订单号
  - [x] 保存订单记录
  - [x] 返回订单信息

### 2.2 订单查询

- [x] 实现 `getMyOrders()` - 获取我的订单列表（用户端）
  - [x] 支持分页
  - [x] 支持按状态筛选
  - [x] 支持按创建时间排序
- [x] 实现 `getOrderById()` - 获取订单详情
  - [x] 关联用户信息
  - [x] 关联车辆信息
  - [x] 权限校验（用户只能查看自己的订单）
- [x] 实现 `getAdminOrders()` - 获取订单列表（管理端）
  - [x] 支持高级筛选（状态、类型、日期、门店、用户）
  - [x] 支持关键词搜索
  - [x] 支持分页
  - [x] 数据脱敏

### 2.3 订单状态管理

- [x] 实现 `updateOrderStatus()` - 更新订单状态
  - [x] 实现状态机逻辑
  - [x] 限制非法状态转换
  - [x] 记录状态变更历史
  - [x] 触发状态变更通知

### 2.4 订单取消

- [x] 实现 `cancelOrder()` - 取消订单
  - [x] 验证订单状态（只能取消待支付或已支付的订单）
  - [x] 记录取消原因
  - [x] 更新订单状态为已取消
  - [x] 如已支付则触发退款流程
  - [x] 释放车辆预订

### 2.5 退款处理

- [x] 实现 `processRefund()` - 处理退款
  - [x] 计算应退金额（根据取消政策）
  - [x] 更新退款金额
  - [x] 更新支付状态
  - [x] 调用支付接口退款（预留）
  - [x] 记录退款记录

### 2.6 续租申请

- [ ] 实现 `requestExtension()` - 申请续租
  - [ ] 验证订单状态（使用中）
  - [ ] 检查车辆续租期间是否有冲突
  - [ ] 计算续租费用
  - [ ] 创建续租申请记录
- [ ] 实现 `approveExtension()` - 审核续租（管理端）
  - [ ] 审核通过/拒绝
  - [ ] 更新订单结束日期
  - [ ] 创建续租订单

### 2.7 事故处理

- [ ] 实现 `reportAccident()` - 报告事故
  - [ ] 记录事故信息（时间、地点、描述、照片）
  - [ ] 创建事故处理工单
  - [ ] 通知管理员
- [ ] 实现 `handleAccident()` - 处理事故（管理端）
  - [ ] 判断事故严重程度
  - [ ] 记录处理过程
  - [ ] 评估责任和费用
  - [ ] 更新订单状态

### 2.8 订单导出

- [ ] 实现 `exportOrders()` - 导出订单数据
  - [ ] 支持按筛选条件导出
  - [ ] 生成 Excel 文件
  - [ ] 数据脱敏
  - [ ] 返回下载链接

---

## Phase 3: API 控制器层

### 3.1 用户端 API

- [x] 创建 `backend/src/controllers/order.controller.ts`
- [x] 实现 `createOrder` - 创建订单 API
- [x] 实现 `getMyOrders` - 获取我的订单列表 API
- [x] 实现 `getOrderDetail` - 获取订单详情 API
- [x] 实现 `cancelOrder` - 取消订单 API
- [ ] 实现 `requestExtension` - 申请续租 API
- [ ] 实现 `reportAccident` - 报告事故 API

### 3.2 管理端 API

- [x] 实现 `getAdminOrders` - 获取订单列表（管理端）
- [x] 实现 `getAdminOrderDetail` - 获取订单详情（管理端）
- [x] 实现 `updateOrderStatus` - 更新订单状态
- [x] 实现 `processRefund` - 处理退款
- [ ] 实现 `approveExtension` - 审核续租
- [ ] 实现 `handleAccident` - 处理事故
- [ ] 实现 `exportOrders` - 导出订单

### 3.3 参数验证

- [x] 添加请求参数验证
- [x] 添加错误处理
- [x] 统一响应格式

---

## Phase 4: 路由配置

- [x] 在 `backend/src/routes/index.ts` 中添加订单路由
  - [x] 用户端路由（需要登录）
  - [x] 管理端路由（需要管理员权限）

---

## Phase 5: 测试

### 5.1 单元测试

- [x] 创建 `backend/tests/order.test.ts`
- [x] 测试订单创建
- [x] 测试订单查询
- [x] 测试订单状态管理
- [x] 测试订单取消
- [x] 测试退款处理
- [ ] 测试续租申请
- [ ] 测试事故报告
- [x] 确保所有测试通过（100% 通过率 - 28/28 测试通过）

### 5.2 集成测试

- [x] 测试订单完整流程（创建 → 支付 → 取车 → 还车 → 完成）
- [x] 测试订单取消和退款流程
- [ ] 测试续租流程
- [ ] 测试事故处理流程

### 5.3 性能测试

- [ ] 测试订单列表查询性能
- [ ] 测试订单号生成并发性能
- [ ] 测试订单创建响应时间

---

## Phase 6: 文档

- [x] 创建 `backend/docs/ORDER_API.md`
- [x] 编写 API 文档
  - [x] 端点列表
  - [x] 请求/响应示例
  - [x] 错误码说明
  - [ ] 业务流程图
- [x] 编写使用示例

---

## Phase 7: 验收与归档

- [x] 运行所有测试确保 100% 通过
- [x] 代码审查
- [x] 功能验收（核心功能）
- [x] 更新 `docs/开发进度管理.md`
- [x] 归档变更到 OpenSpec

---

## 依赖检查

### 前置依赖

- [x] 用户认证系统已完成
- [x] 车辆管理 API 已完成

### 需要集成的系统（预留接口）

- [ ] 支付系统（微信支付/支付宝）
- [ ] 消息通知系统
- [ ] 短信系统

---

**任务总数**: 约 50+ 个子任务
**已完成**: 核心功能已完成（创建、查询、状态管理、取消、退款），测试 100%通过率(28/28)
**待完成**: 续租申请、事故处理、订单导出等高级功能
**预计工期**: 核心功能 4 天（已完成），高级功能待规划
**当前状态**: 核心功能已验收 ✅
**最后更新**: 2025-10-25

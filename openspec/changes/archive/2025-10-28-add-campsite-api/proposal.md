# 营地管理 API 开发提案

## 变更 ID
`add-campsite-api`

## 变更类型
新功能 (Feature)

## 优先级
P1 - 重要

## 提案人
AI Agent

## 创建时间
2025-10-28

## 概述

为叨叨房车平台开发完整的营地管理 API，支持营地信息管理、预订管理、评价管理等功能。营地管理是房车旅行的重要配套服务，解决房车旅行的住宿和补给问题。

## 业务背景

### 业务价值

1. **完善服务闭环**：为房车租赁用户提供配套的营地预订服务
2. **扩大用户群体**：服务自驾房车用户，不限于平台租赁用户
3. **双模式运营**：支持实时预订和咨询模式，灵活适配不同营地合作方
4. **独立产品运营**：既可配合房车租赁，也可单独预订

### 业务场景

**场景 1：房车租赁用户预订营地**
- 用户租赁房车后，需要预订沿途营地
- 在小程序查看营地列表，选择合适的营地
- 在线预订并支付，到营地出示预订码入住

**场景 2：自驾房车用户预订营地**
- 用户自己有房车，计划周末去郊区营地度假
- 在小程序搜索附近营地，查看设施和价格
- 在线完成预订和支付

**场景 3：咨询模式营地**
- 用户计划去新疆某营地，该营地暂不支持实时预订
- 在营地详情页点击"咨询预订"
- 填写咨询需求，平台客服协助完成预订

## 功能需求

### 核心功能

1. **营地信息管理**
   - 营地基本信息（名称、位置、联系方式、营业时间）
   - 营地设施信息（水电、卫浴、娱乐设施等）
   - 营地图片和详情
   - 营地状态管理（启用/禁用）

2. **预订模式管理**
   - 实时预订模式：支持在线预订和支付
   - 咨询模式：用户提交咨询，客服协助预订
   - 管理端可快速切换预订模式

3. **营位库存管理**
   - 营位类型管理（标准营位、水电营位、豪华营位）
   - 营位数量和价格配置
   - 按日期维护库存
   - 预订自动扣减库存，取消自动释放库存

4. **营地预订管理**
   - 用户在线预订营地
   - 选择营位类型和数量
   - 填写入住信息
   - 在线支付
   - 订单状态管理（待入住/已入住/已完成/已取消）

5. **咨询记录管理**
   - 用户提交咨询需求
   - 客服查看咨询列表
   - 标记处理状态
   - 记录处理备注

6. **营地评价管理**
   - 用户完成订单后可评价营地
   - 评价维度：设施、服务、卫生、位置
   - 支持图片上传
   - 评价展示在营地详情页

## 技术方案

### 数据模型

1. **Campsite（营地）**
   - 基本信息、位置、联系方式
   - 预订模式（实时预订/咨询模式）
   - 状态（启用/禁用）

2. **CampsiteFacility（营地设施）**
   - 设施类型、名称、描述
   - 关联营地

3. **CampsiteSpot（营位）**
   - 营位类型、数量、价格
   - 关联营地

4. **CampsiteBooking（营地预订）**
   - 预订信息、入住时间、营位类型
   - 订单状态、支付信息
   - 关联用户和营地

5. **CampsiteInquiry（营地咨询）**
   - 咨询内容、联系方式
   - 处理状态、处理备注
   - 关联用户和营地

6. **CampsiteReview（营地评价）**
   - 评分、评价内容、图片
   - 关联用户、营地、订单

### API 设计

#### 用户端 API

**营地查询**：
- `GET /api/campsites` - 获取营地列表
- `GET /api/campsites/:id` - 获取营地详情
- `GET /api/campsites/:id/spots` - 获取营位信息

**营地预订**：
- `POST /api/campsites/bookings` - 创建预订
- `GET /api/campsites/bookings/my` - 获取我的预订
- `GET /api/campsites/bookings/:id` - 获取预订详情
- `POST /api/campsites/bookings/:id/cancel` - 取消预订

**营地咨询**：
- `POST /api/campsites/inquiries` - 提交咨询
- `GET /api/campsites/inquiries/my` - 获取我的咨询

**营地评价**：
- `POST /api/campsites/reviews` - 提交评价
- `GET /api/campsites/:id/reviews` - 获取营地评价

#### 管理端 API

**营地管理**：
- `POST /api/admin/campsites` - 创建营地
- `PUT /api/admin/campsites/:id` - 更新营地
- `PUT /api/admin/campsites/:id/status` - 更新营地状态
- `PUT /api/admin/campsites/:id/mode` - 切换预订模式
- `GET /api/admin/campsites` - 获取所有营地
- `DELETE /api/admin/campsites/:id` - 删除营地

**预订管理**：
- `GET /api/admin/campsites/bookings` - 获取所有预订
- `GET /api/admin/campsites/bookings/:id` - 获取预订详情
- `PUT /api/admin/campsites/bookings/:id/status` - 更新预订状态

**咨询管理**：
- `GET /api/admin/campsites/inquiries` - 获取所有咨询
- `PUT /api/admin/campsites/inquiries/:id` - 更新咨询状态

**评价管理**：
- `GET /api/admin/campsites/reviews` - 获取所有评价
- `DELETE /api/admin/campsites/reviews/:id` - 删除评价

### 业务规则

1. **预订模式规则**
   - 新增营地默认为"咨询模式"
   - 咨询模式必须配置客服电话
   - 切换为实时预订前必须完善营位库存
   - 模式切换实时同步到小程序端

2. **库存规则**
   - 仅实时预订模式营地维护实时库存
   - 按日期和营位类型独立计算可用库存
   - 预订成功后自动扣减库存
   - 取消订单后自动释放库存

3. **价格规则**
   - 营位费用按晚数计算
   - 不同营位类型不同价格
   - 支持节假日、周末加价（后台配置）
   - 可使用营地预订专用券或全场通用券

4. **取消退款规则**
   - 入住前 24 小时可取消
   - 入住前 24 小时以上取消，全额退款
   - 入住前 24 小时内取消，扣除 30%违约金
   - 入住后不可取消，不退款

5. **评价规则**
   - 仅已完成订单可评价
   - 完成后 7 天内可评价
   - 评价维度：设施、服务、卫生、位置
   - 可上传最多 9 张图片

## 开发计划

### Phase 1: 数据模型层
- 创建营地相关实体
- 定义数据库表结构
- 配置实体关系

### Phase 2: 营地信息管理
- 营地服务（创建、查询、更新、删除）
- 营地控制器（用户端、管理端）
- 预订模式切换

### Phase 3: 营位库存管理
- 营位服务（创建、查询、更新）
- 库存计算和管理
- 库存扣减和释放

### Phase 4: 营地预订管理
- 预订服务（创建、查询、取消）
- 预订控制器（用户端、管理端）
- 钱包集成（扣款、退款）

### Phase 5: 咨询记录管理
- 咨询服务（创建、查询、更新）
- 咨询控制器（用户端、管理端）

### Phase 6: 营地评价管理
- 评价服务（创建、查询、删除）
- 评价控制器（用户端、管理端）

### Phase 7: 路由配置
- 配置用户端路由
- 配置管理端路由

### Phase 8: 测试开发
- 单元测试
- 集成测试

### Phase 9: API 文档编写
- 编写完整的 API 文档
- 包含请求/响应示例

### Phase 10: 验收与归档
- TypeScript 编译检查
- 运行测试
- 更新开发进度文档

## 风险评估

### 技术风险
- **低风险**：基于现有订单管理和支付集成 API，技术栈成熟

### 业务风险
- **中风险**：双模式运营需要清晰的业务逻辑和状态管理
- **缓解措施**：明确预订模式切换规则，完善状态机设计

## 验收标准

1. ✅ 所有实体创建完成，数据库表结构正确
2. ✅ 营地信息管理功能完整（创建、查询、更新、删除）
3. ✅ 预订模式切换功能正常
4. ✅ 营位库存管理功能完整
5. ✅ 营地预订功能完整（创建、查询、取消、退款）
6. ✅ 咨询记录管理功能完整
7. ✅ 营地评价功能完整
8. ✅ API 文档完整
9. ✅ 代码符合规范
10. ✅ 无 TypeScript 编译错误
11. ✅ 测试通过率 100%

## 相关文档

- 小程序端功能详细设计：`docs/小程序端功能详细设计-优化版.md` 第 5.6 节
- 管理端功能详细设计：`docs/管理端功能详细设计-优化版.md` 第 4.7 节
- 开发进度管理：`docs/开发进度管理.md`


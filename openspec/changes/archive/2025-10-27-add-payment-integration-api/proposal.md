# 变更提案：支付集成 API

## Why

当前订单管理系统已经完成订单创建和状态管理，但缺少实际的支付功能。用户需要完成支付才能使用服务，同时系统需要支持钱包余额管理和退款处理。

**核心需求**：

- 用户需要通过微信支付、支付宝或钱包余额完成订单支付
- 用户需要管理钱包余额（充值、消费、提现）
- 管理员需要配置支付参数和处理退款
- 系统需要正确处理支付回调和异步通知

**业务价值**：

- 完成交易闭环，实现收入
- 提供多种支付方式，提升用户体验
- 通过钱包余额增加用户粘性
- 支持退款，保障用户权益

---

## What Changes

### 1. 数据模型层

- **Wallet（钱包）**：用户钱包信息，余额、冻结金额、提现状态
- **WalletTransaction（钱包交易记录）**：充值、消费、提现、退款记录
- **PaymentConfig（支付配置）**：微信支付、支付宝支付配置参数
- **PaymentRecord（支付记录）**：订单支付记录，包含第三方交易号
- **RefundRecord（退款记录）**：退款申请和处理记录

### 2. 业务逻辑层

**WalletService（钱包服务）**：

- 创建用户钱包
- 查询钱包余额
- 充值（微信/支付宝）
- 余额支付（订单消费）
- 提现申请
- 冻结/解冻金额
- 交易记录查询

**PaymentService（支付服务）**：

- 创建支付订单（统一下单）
- 微信支付（预留接口，等待配置）
- 支付宝支付（预留接口，等待配置）
- 钱包余额支付（优先实现）
- 组合支付（余额+第三方）
- 支付回调处理
- 查询支付状态

**RefundService（退款服务）**：

- 创建退款申请
- 处理退款（原路退回/退到钱包）
- 退款回调处理
- 查询退款状态

### 3. API 控制器层

**WalletController（钱包控制器）**：

- 获取钱包信息（用户端）
- 钱包充值
- 提现申请
- 交易记录查询
- 钱包管理（管理端）

**PaymentController（支付控制器）**：

- 创建支付
- 查询支付状态
- 支付回调接口（微信/支付宝）
- 支付配置管理（管理端）

**RefundController（退款控制器）**：

- 创建退款申请
- 处理退款（管理端）
- 查询退款状态
- 退款回调接口

### 4. 工具类和中间件

- `backend/src/utils/wechat-pay.ts`：微信支付 SDK 封装（预留）
- `backend/src/utils/alipay.ts`：支付宝支付 SDK 封装（预留）
- `backend/src/utils/payment-signature.ts`：支付签名验证
- `backend/src/middlewares/payment-notify.ts`：支付回调验证中间件

---

## Impact

### 影响的模块

- **新增模块**：钱包管理、支付集成、退款处理
- **关联模块**：订单管理（订单支付、订单退款）
- **依赖模块**：用户认证（用户 ID）

### 数据库变更

- 新增表：`wallets`、`wallet_transactions`、`payment_configs`、`payment_records`、`refund_records`
- 修改表：`orders`（添加支付记录 ID、退款记录 ID 关联）

### API 变更

**新增 API**：

- 用户端：钱包查询、充值、提现、交易记录、支付接口
- 管理端：钱包管理、支付配置、退款处理
- 回调端：微信/支付宝支付回调、退款回调

**修改 API**：

- 订单创建：增加支付选项
- 订单取消：触发退款流程

### 配置变更

- 环境变量：添加微信支付、支付宝支付配置参数（可通过管理端配置）
- 数据库：PaymentConfig 表存储支付配置

### 安全考虑

- 支付回调需验证签名，防止伪造
- 钱包操作需严格权限校验
- 敏感信息（支付密钥）需加密存储
- 支付金额需精确计算，防止溢出

---

## 实施阶段

### 阶段 1：钱包功能（优先）

- 创建钱包实体和服务
- 实现余额支付
- 实现钱包充值（预留第三方支付接口）
- 实现提现功能

### 阶段 2：支付框架

- 搭建支付服务架构
- 实现支付回调处理机制
- 预留微信支付、支付宝支付接口
- 实现支付配置管理

### 阶段 3：退款功能

- 实现退款申请
- 实现退款处理（钱包退款优先）
- 预留第三方退款接口
- 实现退款回调处理

### 阶段 4：集成和测试

- 整合订单支付流程
- 编写完整测试用例
- 生成 API 文档
- 验收和归档

---

## 业务规则

### 钱包规则

- 每个用户只能有一个钱包
- 钱包余额不能为负数
- 提现需要实名认证
- 提现金额不能超过可用余额
- 提现手续费可配置

### 支付规则

- 订单支付时限：15 分钟
- 超时未支付订单自动取消
- 支付金额必须与订单金额一致
- 支持组合支付（余额+第三方）
- 支付成功后订单状态自动更新

### 退款规则

- 只有已支付订单可以退款
- 退款金额不能超过实付金额
- 退款默认原路返回
- 钱包支付退款到钱包
- 第三方支付退款到原支付账户（预留）
- 退款处理时间：1-7 个工作日

---

## 非功能性需求

- **性能**：支付接口响应时间 < 3 秒
- **可靠性**：支付回调需要重试机制
- **安全性**：支付数据传输使用 HTTPS，签名验证
- **可扩展性**：预留接口，支持后续接入更多支付方式

---

**提案创建时间**：2025-10-25
**提案作者**：叨叨房车开发团队
**优先级**：P0（核心功能）

# Tasks: 小程序用户登录与注册功能

**Change ID**: `add-miniprogram-login`
**Status**: 🟡 Pending
**Total Tasks**: 30

---

## 1. 准备工作

- [ ] 1.1 阅读登录功能详细设计文档(`docs/开发进度管理.md` 模块 18)
- [ ] 1.2 阅读技术规范手册(`docs/技术规范手册.md`)
- [ ] 1.3 确认后端登录 API 可用性(已完成,需验证)
- [ ] 1.4 确认 uView Plus 组件库可用性
- [ ] 1.5 确认 Pinia Store 和 API 模块完整性

## 2. 创建 HTML 原型(C 端小程序页面必须先创建原型)

- [x] 2.1 创建 `miniprogram/pages-prototype/login.html`
- [x] 2.2 实现登录方式切换 UI(一键登录 / 验证码登录)
- [x] 2.3 实现多平台一键登录按钮原型
  - [x] 微信一键登录按钮
  - [x] 支付宝一键登录按钮
  - [x] 抖音一键登录按钮
  - [x] H5 平台提示
- [x] 2.4 实现手机号验证码登录原型
  - [x] 手机号输入框
  - [x] 验证码输入框
  - [x] 获取验证码按钮(60 秒倒计时)
  - [x] 登录按钮
- [x] 2.5 实现用户协议勾选原型
- [x] 2.6 实现页面样式(品牌色、间距、布局)
- [x] 2.7 向用户汇报原型已完成,等待用户确认

## 3. 验证后端 API

- [ ] 3.1 测试 `POST /api/auth/send-code` 发送验证码接口
- [ ] 3.2 测试 `POST /api/auth/sms-login` 手机号登录接口
- [ ] 3.3 测试 `POST /api/auth/wechat-login` 微信登录接口
- [ ] 3.4 确认 API 返回格式符合前端需求

## 4. 实现登录页面(移植原型到正式页面)

- [x] 4.1 创建 `miniprogram/pages/login/index.vue`
- [x] 4.2 导入依赖
  - [x] 导入 `useUserStore`
  - [x] 导入 `router` 工具
  - [x] 导入 Vue 3 Composition API
- [x] 4.3 实现页面状态管理
  - [x] 登录方式状态(`loginMode`: 'quick' | 'phone')
  - [x] 平台检测状态(`platform`: 'wechat' | 'alipay' | 'douyin' | 'h5')
  - [x] 手机号状态(`phone`)
  - [x] 验证码状态(`code`)
  - [x] 倒计时状态(`countdown`)
  - [x] 用户协议勾选状态(`agreedToTerms`)
- [x] 4.4 实现平台检测逻辑
- [x] 4.5 实现登录方式切换逻辑

## 5. 实现手机号验证码登录

- [x] 5.1 实现手机号格式验证
- [x] 5.2 实现 `sendCode` 函数
  - [x] 验证手机号格式
  - [x] 调用 `userStore.sendCode(phone)`
  - [x] 开始 60 秒倒计时
  - [x] 显示成功/失败提示
- [x] 5.3 实现 `handlePhoneLogin` 函数
  - [x] 验证手机号和验证码
  - [x] 验证用户协议勾选
  - [x] 调用 `userStore.smsLogin({ phone, code })`
  - [x] 保存 token
  - [x] 获取重定向路径并跳转
  - [x] 显示成功/失败提示

## 6. 实现多平台一键登录

- [x] 6.1 实现微信一键登录
  - [x] 实现 `handleWechatLogin` 函数
  - [x] 验证用户协议勾选
  - [x] 调用 `uni.login()` 获取 code
  - [x] 调用 `uni.getUserProfile()` 获取用户信息(可选)
  - [x] 调用 `userStore.wechatLogin({ code, nickname, avatar })`
  - [x] 保存 token 并跳转
- [x] 6.2 实现支付宝一键登录(预留)
  - [x] 实现 `handleAlipayLogin` 函数
  - [x] 调用支付宝登录 API
  - [x] 调用 `userStore.alipayLogin(params)`
- [x] 6.3 实现抖音一键登录(预留)
  - [x] 实现 `handleDouyinLogin` 函数
  - [x] 调用抖音登录 API
  - [x] 调用 `userStore.douyinLogin(params)`

## 7. 实现智能重定向

- [x] 7.1 从 router 获取重定向路径
- [x] 7.2 登录成功后清除重定向路径
- [x] 7.3 如果有重定向路径,跳转到原目标页面
- [x] 7.4 如果没有重定向路径,跳转到首页

## 8. 实现用户协议

- [ ] 8.1 实现用户协议勾选框
- [ ] 8.2 实现协议文本链接(跳转到协议详情页)
- [ ] 8.3 实现未勾选时的验证和提示

## 9. 样式开发

- [ ] 9.1 实现页面整体布局样式
- [ ] 9.2 实现登录方式切换样式
- [ ] 9.3 实现一键登录按钮样式
- [ ] 9.4 实现手机号验证码登录样式
- [ ] 9.5 实现用户协议样式
- [ ] 9.6 实现响应式适配(rpx 单位)
- [ ] 9.7 实现品牌色彩应用(#667eea, #764ba2)

## 10. 功能测试

- [ ] 10.1 测试微信小程序一键登录
- [ ] 10.2 测试手机号验证码登录
  - [ ] 测试手机号格式验证
  - [ ] 测试验证码发送
  - [ ] 测试验证码倒计时
  - [ ] 测试登录成功流程
  - [ ] 测试登录失败处理
- [ ] 10.3 测试用户协议勾选验证
- [ ] 10.4 测试智能重定向
  - [ ] 从路由拦截器跳转到登录页
  - [ ] 登录成功后返回原目标页面
  - [ ] 直接访问登录页后跳转到首页
- [ ] 10.5 测试 Token 保存和持久化
- [ ] 10.6 测试路由拦截器集成

## 11. 多端测试

- [ ] 11.1 微信小程序测试
  - [ ] 微信一键登录
  - [ ] 手机号验证码登录
- [ ] 11.2 H5 测试
  - [ ] 手机号验证码登录
  - [ ] 一键登录提示
- [ ] 11.3 支付宝小程序测试(可选)
- [ ] 11.4 抖音小程序测试(可选)

## 12. 代码质量检查

- [ ] 12.1 ESLint 检查通过
- [ ] 12.2 TypeScript 类型检查通过
- [ ] 12.3 代码审查(遵循技术规范手册)
- [ ] 12.4 性能优化检查

## 13. 文档更新

- [ ] 13.1 更新开发进度管理文档(标记模块 18 为"已完成")
- [ ] 13.2 在对话中向用户汇报完成情况

---

## 注意事项

### ⚠️ C 端小程序页面开发流程

1. **必须先创建 HTML 原型**(任务 2.1-2.7)
2. **等待用户确认原型**后才能继续
3. **移植时仅修正语法**,不改变设计
4. **保留原型代码**在 `login.html` 中

### ⚠️ 技术栈约束

- ❌ 禁止使用标准 HTML 标签(`<div>`, `<span>`, `<img>`)
- ✅ 必须使用 uni-app 内置组件(`<view>`, `<text>`, `<image>`)
- ✅ 必须使用 uView Plus 组件
- ✅ 必须使用 Vue 3 Composition API

### ⚠️ 后端 API 依赖

以下 API 已完成(需验证):

- `POST /api/auth/send-code` - 发送验证码
- `POST /api/auth/sms-login` - 手机号验证码登录
- `POST /api/auth/wechat-login` - 微信一键登录
- `POST /api/auth/alipay-login` - 支付宝一键登录(预留)
- `POST /api/auth/douyin-login` - 抖音一键登录(预留)

### ⚠️ 关键依赖

- `miniprogram/api/modules/user.ts` - API 模块(已完成)
- `miniprogram/store/modules/user.ts` - Pinia Store(已完成)
- `miniprogram/utils/router.ts` - 路由工具(已完成)
- `miniprogram/utils/auth.ts` - Token 管理(已完成)

---

## 验收清单

### 功能验收

- [ ] 微信小程序可以使用微信一键登录
- [ ] 所有平台都支持手机号验证码登录
- [ ] 验证码发送成功并显示倒计时
- [ ] 登录成功后 Token 正确保存到 localStorage 和 Pinia
- [ ] 登录成功后正确跳转到原目标页面或首页
- [ ] 用户协议未勾选时阻止登录并提示
- [ ] 手机号格式验证正常
- [ ] 验证码格式验证正常
- [ ] 路由拦截器集成正常

### 质量验收

- [ ] 微信小程序测试通过
- [ ] H5 浏览器测试通过
- [ ] 代码符合 ESLint 规范
- [ ] 无 TypeScript 类型错误
- [ ] 代码测试覆盖率 ≥ 80%

### 性能验收

- [ ] 登录响应时间 < 2s
- [ ] 页面加载时间 < 1s
- [ ] 无卡顿和闪烁

---

## 总任务数统计

- **总任务数**: 30
- **已完成**: 0
- **进行中**: 0
- **未开始**: 30
- **完成率**: 0%

# 完善房车预订模块功能实现

## Why

当前房车预订模块 (`BookingModule.vue`) 仅实现了基础的 UI 展示,缺少完整的交互逻辑、数据验证和后端对接。这导致用户无法真正使用预订功能,严重影响核心业务流程。

根据 `docs/小程序端功能详细设计-优化版.md` 第 5.1.3 节的详细需求,房车预订模块是首页最核心的功能,需要提供:
- 城市和门店的智能选择
- 时间选择器与业务规则验证
- 异地还车功能
- 完整的数据验证和错误处理
- 与后端 API 的对接

## What Changes

### 核心功能实现

- ✅ **城市门店选择器**
  - 实现城市选择弹窗,支持搜索和热门城市
  - 实现门店选择弹窗,根据城市联动显示
  - 支持异地还车的城市和门店选择
  - 记住用户上次选择,优化体验

- ✅ **时间选择器**
  - 实现取车时间选择器(日期+时间)
  - 实现还车时间选择器,自动同步时间点
  - 实时计算租期天数
  - 验证时间业务规则(最短 2 天,最长 60 天)

- ✅ **数据验证**
  - 必填字段验证
  - 时间逻辑验证(还车时间必须晚于取车时间)
  - 租期长度验证(2-60 天)
  - 取还车时间点一致性验证

- ✅ **默认值智能设置**
  - 优先使用用户上次选择
  - 自动定位用户城市
  - 取车时间默认为当前时间+4 小时(整点)
  - 还车时间默认为取车时间+2 天

- ✅ **API 对接**
  - 获取可用城市列表
  - 获取城市门店列表
  - 查询可用房车
  - 保存用户选择记录

### UI/UX 优化

- 保持现有卡片式设计风格
- 优化选择器交互体验
- 添加加载状态和错误提示
- 优化异地还车展开/收起动画

## Impact

### 影响的规范

- **新增**: `specs/booking-module/spec.md` - 房车预订模块完整规范
- **关联**: `specs/home-page/spec.md` - 首页规范(已存在)

### 影响的代码

- **主要修改**: `miniprogram/pages/index/components/BookingModule.vue`
- **新增 API**: `miniprogram/api/modules/booking.ts`
- **新增类型**: `miniprogram/types/booking.d.ts`
- **新增组件**: 
  - `miniprogram/components/common/CityPicker.vue` - 城市选择器
  - `miniprogram/components/common/StorePicker.vue` - 门店选择器
  - `miniprogram/components/common/DateTimePicker.vue` - 日期时间选择器

### 数据流

```
用户操作 → BookingModule → 选择器组件 → API 请求 → 后端服务
                ↓
            数据验证
                ↓
            状态更新
                ↓
            UI 反馈
```

### 兼容性

- ✅ 向后兼容:保持现有 UI 设计和事件接口
- ✅ 无破坏性变更:仅增强功能,不改变现有行为
- ✅ 渐进式实现:可分阶段上线功能

### 风险评估

- **低风险**: UI 组件独立,不影响其他模块
- **中风险**: 需要后端 API 配合,需协调开发进度
- **缓解措施**: 使用 Mock 数据先完成前端开发,后续对接真实 API

## Success Criteria

- [ ] 用户可以选择城市和门店
- [ ] 用户可以选择取还车时间
- [ ] 系统正确验证所有业务规则
- [ ] 点击查询按钮可以跳转到房车列表页
- [ ] 所有异常场景都有友好的错误提示
- [ ] 用户选择会被记住,下次打开自动填充
- [ ] 通过所有单元测试和集成测试

## Timeline

- **阶段 1** (2 天): 实现选择器组件和基础交互
- **阶段 2** (1 天): 实现数据验证和业务规则
- **阶段 3** (1 天): API 对接和状态管理
- **阶段 4** (1 天): 测试和优化

**总计**: 5 个工作日


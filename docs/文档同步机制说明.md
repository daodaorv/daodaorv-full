# 文档同步机制说明

**创建时间**: 2025-01-11
**文档类型**: 规范文档
**用途**: 确保代码实现与进度文档、OpenSpec规范保持同步

---

## 📋 同步机制概述

为确保项目进度文档（`docs/开发进度管理.md`）与实际代码实现保持一致，建立以下同步机制：

### 1. 开发完成后的同步流程

#### 1.1 完成功能开发后必须执行

1. **更新代码状态**
   - 完成功能实现
   - 编写并运行测试（100%通过率）
   - 代码审查通过

2. **更新进度文档**
   - 立即更新 `docs/开发进度管理.md` 中对应模块的状态
   - 从"未开始"或"进行中"更新为"已完成"或"已验收"
   - 添加完成时间和测试通过率信息

3. **创建/归档OpenSpec变更**
   - 如果已有OpenSpec提案，更新 `tasks.md` 标记所有任务为完成
   - 运行 `openspec archive <change-id> --yes` 归档变更
   - 如果缺少OpenSpec提案，立即创建并归档

4. **验证同步**
   - 运行 `openspec validate --strict` 确保没有错误
   - 检查进度文档与实际文件是否一致

### 2. 定期同步检查（建议每周）

#### 2.1 检查清单

- [ ] 对比实际代码文件与进度文档记录
- [ ] 检查是否有已实现但未记录的功能
- [ ] 检查是否有已归档但未实现的变更
- [ ] 验证OpenSpec变更状态（已归档 vs 未归档）

#### 2.2 同步操作脚本建议

可以创建自动化脚本（如 `scripts/sync-progress.md`）定期执行：

```bash
# 伪代码示例
1. 扫描 miniprogram/pages/ 目录，统计实际页面数
2. 扫描 admin-console/src/views/ 目录，统计实际页面数
3. 对比 docs/开发进度管理.md 中的记录
4. 输出差异报告
5. 提示需要更新的内容
```

### 3. 文件变更追踪

#### 3.1 Git提交规范

每次完成功能模块后，提交信息应包含：

```
feat(miniprogram): 完成社区模块开发

- 创建6个社区页面（首页、发布、详情、搜索、通知、分析）
- 集成后端API
- 更新进度文档：模块27状态改为"已完成"
- 归档OpenSpec变更：add-miniprogram-community-pages
```

#### 3.2 提交前检查

- [ ] 代码已通过测试
- [ ] 进度文档已更新
- [ ] OpenSpec变更已归档（如适用）
- [ ] 无TypeScript编译错误
- [ ] 无ESLint错误

### 4. 进度文档更新规范

#### 4.1 状态定义

- **未开始**: 尚未创建任何代码文件
- **进行中**: 已创建文件但功能未完整实现
- **已完成**: 功能已完整实现，代码已创建，但可能未测试或未验收
- **已验收**: 功能已完整实现并通过测试和验收

#### 4.2 更新时机

- ✅ **必须立即更新**: 完成功能开发后
- ✅ **必须立即更新**: 归档OpenSpec变更后
- ✅ **建议定期更新**: 每周一次全面检查

#### 4.3 更新内容

每次更新应包含：

1. **模块状态**: 更新状态字段
2. **完成时间**: 记录实际完成日期
3. **测试状态**: 记录测试通过率（如适用）
4. **OpenSpec状态**: 记录归档状态
5. **功能说明**: 更新实际实现的功能描述

### 5. OpenSpec变更管理

#### 5.1 变更创建时机

**必须在开发前创建**（如需要）:
- 新功能开发
- 破坏性变更
- 架构变更

**可以在开发后创建**（如遗漏）:
- 发现已实现功能但没有OpenSpec变更
- 需要补全文档

#### 5.2 变更归档时机

**必须立即归档**:
- 功能开发完成
- 所有测试通过
- 所有任务完成

#### 5.3 归档检查清单

归档前必须确认：

- [ ] `tasks.md` 中所有任务标记为 `[x]`
- [ ] 所有测试通过（100%）
- [ ] 代码已提交到版本控制
- [ ] 进度文档已更新
- [ ] 运行 `openspec validate <change-id> --strict` 无错误

归档命令：

```bash
openspec archive <change-id> --yes
```

### 6. 同步问题处理

#### 6.1 发现不一致时的处理

**情况1**: 代码已实现但进度文档未记录

1. 检查是否有OpenSpec变更
2. 如果有，检查是否已归档
3. 更新进度文档，标记为"已完成"
4. 创建或归档OpenSpec变更（如缺失）
5. 更新完成时间和说明

**情况2**: 进度文档记录已完成但代码未实现

1. 确认代码文件确实不存在
2. 更新进度文档状态为"未开始"或"进行中"
3. 检查是否有OpenSpec变更，如有则更新状态

**情况3**: OpenSpec变更状态与实际不符

1. 检查变更目录是否存在
2. 检查是否在 `archive/` 目录下
3. 如已归档，确认 `openspec/specs/` 是否已更新
4. 如未归档，检查是否应该归档

### 7. 自动化建议

#### 7.1 建议创建同步脚本

可以创建脚本文件 `scripts/sync-docs.sh` 或 `scripts/sync-docs.ps1`:

**功能**:
- 扫描各端实际文件
- 对比进度文档记录
- 生成差异报告
- 提示需要更新的内容

**执行频率**: 建议每周执行一次，或每次重要功能完成后执行

#### 7.2 Git Hooks

可以设置Git pre-commit hook，在提交前自动检查：

- 是否有未归档的OpenSpec变更
- 是否有未更新的进度文档

---

## 📊 同步状态检查表

### 当前状态检查（2025-01-11）

#### 后端API
- ✅ 所有模块已完成并归档
- ✅ 进度文档准确

#### 小程序端
- ⚠️ 社区模块已实现，需创建OpenSpec变更并归档
- ⚠️ 优惠券模块已实现，需创建OpenSpec变更并归档
- ⚠️ 订单确认页已创建，需创建OpenSpec变更并归档
- ⚠️ 进度文档已更新（本次）

#### PC管理端
- ⚠️ 用户管理已实现，需创建OpenSpec变更并归档
- ⚠️ 进度文档已更新（本次）

#### 移动管理端
- ✅ 进度文档准确（仅有基础结构）

---

## 🔄 持续改进

### 建议改进措施

1. **建立定期检查机制**
   - 每周执行一次全面同步检查
   - 每月生成同步状态报告

2. **自动化同步**
   - 开发同步检查脚本
   - 集成到CI/CD流程（如适用）

3. **文档模板化**
   - 标准化进度文档更新格式
   - 提供更新模板和检查清单

---

**文档维护责任**: AI开发团队
**最后更新时间**: 2025-01-11
**下次检查时间**: 建议每周一次

